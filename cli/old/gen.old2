#!/bin/bash

CLI_ROOT="/var/www/gs/cli"
COMMON="$CLI_ROOT/utils.sh"
BG_DIR="$CLI_ROOT/bg"
PID_FILE="/tmp/gen-daemon.pid"
LOG_FILE="/var/www/gs/log/gen20.log"
DAEMON="$BG_DIR/daemon-update.sh"
COM_DIR="$CLI_ROOT/com"

# Î’ÎµÎ²Î±Î¹ÏÏƒÎ¿Ï… ÏŒÏ„Î¹ Ï„Î¿ .env ÎµÎ¯Î½Î±Î¹ Ï†Î¿ÏÏ„Ï‰Î¼Î­Î½Î¿
ENV_FILE="/var/www/gs/.env"
if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE"
    echo "ğŸ”§ Î¤Î¿ .env Î­Ï‡ÎµÎ¹ Ï†Î¿ÏÏ„Ï‰Î¸ÎµÎ¯ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚."
else
    echo "âŒ Î£Ï†Î¬Î»Î¼Î±: Î›ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ .env."
    exit 1
fi

# Î¦Î¿ÏÏ„ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ utils.sh
if [ -f "$COMMON" ]; then
    source "$COMMON"
else
    error "Î›ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ utils.sh."
fi

# Î¦Î¿ÏÏ„ÏÎ½Î¿Ï…Î¼Îµ Ï„Î·Î½ "ÎºÎ»Î¬ÏƒÎ·" BaseObject
BASE_CLASS="$CLI_ROOT/base_class.sh"
if [ -f "$BASE_CLASS" ]; then
    source "$BASE_CLASS"
else
    error "Î›ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ base_class.sh."
fi

# Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ±Î¹ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· Î±Î½Ï„Î¹ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… Î±Ï€ÏŒ Ï„Î· "ÎºÎ»Î¬ÏƒÎ·"
initialize_base_object "MyObject"
show_base_object

# Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ÎµÎ½Î­ÏÎ³ÎµÎ¹Î±Ï‚ ÏƒÏ„Î¿ Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î¿
perform_action

# ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï€Î±ÏÎ±Î¼Î­Ï„ÏÏ‰Î½
if [ -z "$1" ]; then
    error "Usage: $0 <system> <command> [args...]"
fi

COMMAND="$1"
FILENAME="$2"

# ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï€ÏÏŒÎºÎµÎ¹Ï„Î±Î¹ Î³Î¹Î± Ï€ÏÎ¿ÎºÎ±Î¸Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î· ÎµÎ½Ï„Î¿Î»Î® daemon
case "$COMMAND" in
    start)
        start_daemon
        exit 0
        ;;
    stop)
        stop_daemon
        exit 0
        ;;
    restart)
        restart_daemon
        exit 0
        ;;
    all)
        if [ -n "$FILENAME" ]; then
            for dir in "$COM_DIR"/*/; do
                CMD_NAME=$(basename "$dir")
                SCRIPT="$dir/$FILENAME.sh"
                if [ -f "$SCRIPT" ]; then
                    log "â–¶ Î•ÎºÏ„Î­Î»ÎµÏƒÎ· $CMD_NAME/$FILENAME.sh..."
                    bash "$SCRIPT"
                else
                    log "âš  Î›ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ script Î³Î¹Î± Ï„Î¿ $CMD_NAME/$FILENAME"
                fi
            done
        else
            log "âŒ Î£Ï†Î¬Î»Î¼Î±: Î¤Î¿ FILENAME Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯."
            exit 1
        fi
        exit 0
        ;;
          # Handle predefined system commands
          action|ai|chat|cubo|db|domain|ermis|gaia|git|god|kronos|mars|micro|wp|ws)
       if [ -n "$FILENAME" ]; then
                  SCRIPT="$COM_DIR/$COMMAND/$FILENAME.sh"
                  if [ -f "$SCRIPT" ]; then
                      bash "$SCRIPT"
                      exit $?
                  else
                      log "âŒ Error: Script not found for $COMMAND/$FILENAME"
                      exit 1
                  fi
              else
                  log "ğŸ“‚ Listing available scripts in $COM_DIR/$COMMAND:"
                  # List scripts without the .sh extension
                  ls -1 "$COM_DIR/$COMMAND/" | grep -E '\.sh$' | sed 's/\.sh$//' || log "âš  No scripts found in $COM_DIR/$COMMAND"
                  exit 0
              fi
              ;;

esac
